<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Wizardry(NES) 解析 - 敵からの打撃攻撃</title>
</head>

<body>

<h1>Wizardry(NES) 解析 - 敵からの打撃攻撃</h1>

<p>敵からの打撃攻撃、および追加効果(毒、麻痺など)について。</p>

<p>敵からの打撃攻撃に関しては、PTキャラのACは全く意味を持たない(バグと思われ
る)。また、追加効果の回避判定においては全く関係ない属性抵抗が使われることが
ある。</p>


<h2>処理の流れ</h2>

<p>攻撃対象は<a href="battle_enemy_act.html">敵の行動</a>決定時に既に決めら
れていることに注意。</p>

<ul>
  <li>攻撃対象が死亡(DEAD以上)していたら処理を終える(PTキャラの打撃攻撃と異な
  り、オートターゲット機能がない)</li>
  <li>命中率計算</li>
  <li>ダメージ計算</li>
  <li>命中回数が0ならば処理を終える。また、攻撃対象のHPが0以下になったら死亡
  処理を行って終了</li>
  <li>攻撃者が毒攻撃能力を持っていたら毒判定</li>
  <li>攻撃者が麻痺攻撃能力を持っていたら麻痺判定</li>
  <li>攻撃者が石化攻撃能力を持っていたら石化判定</li>
  <li>攻撃者がドレイン能力を持っていたらドレイン判定。攻撃対象がドレインを受
  けてロストしたら処理終了</li>
  <li>攻撃者がクリティカル能力を持っていたらクリティカル判定</li>
</ul>


<h2>命中率</h2>

<p>攻撃1回当たりの命中率は以下の要素に依存する(攻撃対象のACは何の影響も及ぼ
さないことに注意):</p>
<ul>
  <li>攻撃対象がPARRYを行ったかどうか</li>
  <li>攻撃者の<a href="battle_system.html">キャラ番号</a></li>
  <li>攻撃者のモンスターLV</li>
  <li><strong>攻撃者の</strong>AC</li>
</ul>

<p>まず、次式で値 A, B を求める:</p>
<blockquote>
  A = 19 + (PARRYボーナス) - P - (モンスターLV)<br>
  B = A - (攻撃者のAC)
</blockquote>
<p>ここで、PARRYボーナスは攻撃対象がPARRYを行っていれば2, さもなくば0。P は
攻撃者のキャラ番号に依存する値(本来は攻撃対象のACだったのだろうが、バグのた
め違うアドレスの値を参照している)で、対応表は以下の通り(位置 (a,b) は「敵第a
グループのb体目」を表す。また、訓練所内IDはキャラの訓練所内での番号
(0-origin)):</p>
<table border="1">
<thead>
  <tr><th>位置</th><th>P</th></tr>
</thead>
<tbody>
  <tr><td>(1,1)</td><td>PT1人目のPOISON値</td></tr>
  <tr><td>(1,2)</td><td>PT2人目のPOISON値</td></tr>
  <tr><td>(1,3)</td><td>PT3人目のPOISON値</td></tr>
  <tr><td>(1,4)</td><td>PT4人目のPOISON値</td></tr>
  <tr><td>(1,5)</td><td>PT5人目のPOISON値</td></tr>
  <tr><td>(1,6)</td><td>PT6人目のPOISON値</td></tr>
  <tr><td>(1,7)</td><td>0x60 + PT1人目の訓練所内ID</td></tr>
  <tr><td>(1,8)</td><td>0x60 + PT2人目の訓練所内ID</td></tr>
  <tr><td>(1,9)</td><td>0x60 + PT3人目の訓練所内ID</td></tr>
  <tr><td>(2,1)</td><td>0x60 + PT4人目の訓練所内ID</td></tr>
  <tr><td>(2,2)</td><td>0x60 + PT5人目の訓練所内ID</td></tr>
  <tr><td>(2,3)</td><td>0x60 + PT6人目の訓練所内ID</td></tr>
  <tr><td>(2,4)</td><td>(未解析。アドレス $7DE2)</td></tr>
  <tr><td>(2,5)</td><td>(未解析。アドレス $7DE3)</td></tr>
  <tr><td>(2,6)</td><td>(未解析。アドレス $7DE4)</td></tr>
  <tr><td>(2,7)</td><td>(未解析。アドレス $7DE5)</td></tr>
  <tr><td>(2,8)</td><td>(未解析。アドレス $7DE6)</td></tr>
  <tr><td>(2,9)</td><td>(未解析。アドレス $7DE7)</td></tr>
  <tr><td>(3,1)</td><td>(未解析。アドレス $7DE8)</td></tr>
  <tr><td>(3,2)</td><td>(未解析。アドレス $7DE9)</td></tr>
  <tr><td>(3,3)</td><td>(未解析。アドレス $7DEA)</td></tr>
  <tr><td>(3,4)</td><td>(未解析。アドレス $7DEB)</td></tr>
  <tr><td>(3,5)</td><td>(未解析。アドレス $7DEC)</td></tr>
  <tr><td>(3,6)</td><td>(未解析。アドレス $7DED)</td></tr>
  <tr><td>(3,7)</td><td>エンカウントの種類?(アドレス $7DEE)</td></tr>
  <tr><td>(3,8)</td><td>PTの人数(生死問わず)</td></tr>
  <tr><td>(3,9)</td><td>(未解析。アドレス $7DF0)</td></tr>
  <tr><td>(4,1)</td><td>(未解析。アドレス $7DF1)</td></tr>
  <tr><td>(4,2)</td><td>(未解析。アドレス $7DF2)</td></tr>
  <tr><td>(4,3)</td><td>(未解析。アドレス $7DF3)</td></tr>
  <tr><td>(4,4)</td><td>(未解析。アドレス $7DF4)</td></tr>
  <tr><td>(4,5)</td><td>(未解析。アドレス $7DF5)</td></tr>
  <tr><td>(4,6)</td><td>ALARMフラグ?(アドレス $7DF6)</td></tr>
  <tr><td>(4,7)</td><td>前回の宝箱罠?(アドレス $7DF7)</td></tr>
  <tr><td>(4,8)</td><td>PT1人目の前回の宝箱罠調査結果?(アドレス $7DF8)</td></tr>
  <tr><td>(4,9)</td><td>PT2人目の前回の宝箱罠調査結果?(アドレス $7DF9)</td></tr>
  <!-- TODO: 宝箱罠関連については前回の値が保存されたままになるのかどうか要検証 -->
</tbody>
</table>

<p>次に、A, B の値によって「命中判定値」を求める。命中判定値は:</p>
<ul>
  <li>19 &lt;= B ならば 19</li>
  <li>0 &lt;= B &lt; 19 ならば B</li>
  <li>-36 &lt;= B &lt; 0 ならば 0</li>
  <li>B &lt; -36 ならば
    <ul>
      <li>A &lt; 0 ならば 0</li>
      <li>A &gt;= 0 ならば 19</li>
    </ul>
  </li>
</ul>

<p>そして、攻撃1回当たりの命中率は次式で表される:</p>
<blockquote>
  (命中率) = (19-(命中判定値)) / 20
</blockquote>
<p>つまり、命中判定値が19ならば攻撃は決して命中しない。また、命中率は最大
19/20 である。</p>


<h2>ダメージ</h2>

<p>モンスターは種類ごとに固有の攻撃回数とダメージダイス式テーブル(攻撃回数分)
を持つ。ダメージダイス式はテーブル先頭のものが初期値として使われ、攻撃が1回
命中するたびに次のダイス式に差し替えられる(攻撃が命中しない限りダイス式は変
化しないことに注意)。</p>

<p>上記を踏まえて攻撃回数分の命中判定を行い、1回命中するごとにダイスを振り、
その値の合計をダメージとする。</p>

<p>攻撃対象がステータス異常にかかっている場合、更にダメージが2倍になる。</p>


<h2>毒判定</h2>

<p>毒を受けた場合、攻撃対象のPOISON値が1になる。</p>

<p>毒を受ける確率は攻撃対象の運勢値1および属性抵抗に依存する。まず、</p>
<blockquote>
  (19-(運勢値1)) / 20
</blockquote>
<p>の確率で毒を回避できる。この判定で回避できなかった場合、吸収属性抵抗があ
れば100%毒を回避できる。以上全ての判定で回避できなければ毒を受ける。</p>


<h2>麻痺判定</h2>

<p>麻痺(PARALY)を受ける確率は攻撃対象の運勢値1および属性抵抗に依存する。まず、</p>
<blockquote>
  (19-(運勢値1)) / 20
</blockquote>
<p>の確率で麻痺を回避できる。この判定で回避できなかった場合、火属性抵抗があ
れば100%麻痺を回避できる。以上全ての判定で回避できなければ麻痺を受ける。</p>


<h2>石化判定</h2>

<p>石化(PETRIF)を受ける確率は攻撃対象の運勢値1および属性抵抗に依存する。まず、</p>
<blockquote>
  (19-(運勢値1)) / 20
</blockquote>
<p>の確率で石化を回避できる。この判定で回避できなかった場合、呪文属性抵抗が
あれば100%石化を回避できる。以上全ての判定で回避できなければ石化を受ける。</p>


<h2>ドレイン判定</h2>

<p>ドレインLVはモンスターの種類ごとに固定(ランダム要素なし)。また、各PTキャ
ラが1戦闘で受けるドレイン回数は1回まで(既にドレインを受けたキャラの場合、ド
レイン判定がスキップされる)。</p>

<p>まだドレインを受けていないキャラの場合、石化属性抵抗があれば100%ドレイン
を回避できる。さもなくば100%ドレインを受け、攻撃対象のLVがモンスター固有のド
レインLV分減少する。この結果LVが0以下になる場合、攻撃対象はLOST状態となり、
処理は終了する。</p>

<h3>最大HP減少</h3>
<p>ドレインを受けてLVが1以上残った場合は、最大HPを減らす処理を行う。最大HP減
少量は、攻撃対象の元の(ドレインを受ける前の)LV, 攻撃対象の最大HP, 攻撃者のド
レインLVに依存する。まず、以下のようにして値 H を求める:</p>
<ul>
  <li>(元LV) &gt; 0xFF の場合、H = (最大HP) / 256</li>
  <li>(元LV) &lt;= 0xFF の場合、H = (最大HP)</li>
</ul>
<p>次に、次式で値 D を求める:</p>
<blockquote>
  D = H/((元LV)%256) + 1<br>
  ※%は余りを求める演算子<br>
  ※(元LV)%256 が0の場合、D = 0
</blockquote>
<p>そして、最大HP減少量は次式で表される:</p>
<blockquote>
  (最大HP減少量) = (ドレインLV)*D
</blockquote>

<p>最大HPを減らした結果 (最大HP) &lt; (現在HP) となる場合は、現在HPを最大HP
と同じにする。</p>

<p>最後に、攻撃対象についてドレインを受けたことを示すフラグが立てられる。</p>


<h2>クリティカル判定</h2>

<p>クリティカルを受けた場合、攻撃対象は即死する。</p>

<p>クリティカルを受ける確率は、攻撃対象の運勢値1, 攻撃対象の属性抵抗、攻撃者
のモンスターLVに依存する。まず、</p>
<blockquote>
  (19-(運勢値1)) / 20
</blockquote>
<p>の確率でクリティカルを回避できる。この判定で回避できなかった場合、</p>
<blockquote>
  (49-(モンスターLV)) / 50
</blockquote>
<p>の確率でクリティカルを回避できる。この判定でも回避できなかった場合、火属
性抵抗があれば100%クリティカルを回避できる。以上全ての判定で回避できなければ
クリティカルを受ける。</p>


<hr>

<p><a href="./">Back</a></p>

</body>
</html>
