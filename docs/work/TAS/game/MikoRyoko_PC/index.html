<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>巫女さんファイター涼子ちゃん (PC) TAS</title>
</head>

<body>

<h1>巫女さんファイター涼子ちゃん (PC) TAS</h1>

<p><strong>※現在、TASツールの乱数処理にバグがあることが判明しています。多分
近日中に修正できると思いますが、今のところ乱数依存かつ0F目で乱数が消費される
ステージはうまく扱えないので注意してください(これまでに私が制作したムービー
については問題ありません)。</strong></p>

<p>以前作った<a href="old.html">コマ送りツール</a>を発展させ、一応コマ送りと
ステート機能を備えたTASツールができました。現在全ステージ制覇に向けて制作中
です(ただし、5-5などの穴掘り面は面倒な割に面白くなさそうなので省略する予定)。</p>

<p>0.2.0 でdesync問題がかなり改善され、ステートロードも高速化されました。</p>

<iframe width="312" height="176" src="http://ext.nicovideo.jp/thumb_mylist/19237088" scrolling="no" style="border:solid 1px #CCC;" frameborder="0"><a href="http://www.nicovideo.jp/mylist/19237088">【ニコニコ動画】</a></iframe>


<h2>TASツール</h2>

<p>MinGWでビルドしています。MSVCでもビルドできるかもしれませんが未確認。DLL
injectionのために<a href="/appsouko/work/dllinject/">dllinject</a>を使用して
います。</p>

<p>ダウンロード:
<a href="/appsouko/souko/pkg/tasryoko-0.2.3.tar.bz2">tasryoko-0.2.3.tar.bz2</a></p>

<p>今のところかなり適当な作りです。desync防止のため、ゲームウィンドウへのキー
入力、マウス入力は無効となり、ウィンドウのアクティブ化もできなくなります
(0.2.1 以降では Ctrl-H で一時的にアクティブ化を許可できます)。ゲームパッドが
ない環境ではメニュー操作やメッセージ送りなどが面倒かもしれません。</p>

<p>今のところ、アイテム取得などでメッセージ表示が入るステージはうまく扱えま
せん。</p>

<p>Windows XP SP3 (32bit)で動作確認しています。</p>

<h3>使い方</h3>

<p><strong>※0.2.0 で偽DLL方式からDLL injection+IATパッチ方式に変更したため、
使い方が変わりました。exe書き換えは不要になったので、もし0.1を使っていた方が
いたら ryoko_fight.exe をオリジナルのものに戻してください。</strong></p>

<p>あらかじめ dllinject.exe, tasryoko.dll, tasryoko.bat を同じディレクトリに
置いておき、ryoko_fight.exe を起動後に tasryoko.bat を実行するとTASツールが
組み込まれます。</p>

<p>TASツールを組み込むと、ゲームウィンドウの他にもう1つのウィンドウが現れま
す。キー入力は全てこのウィンドウに対して行います。</p>

<p>自機座標のアドレスはゲームを起動するたびに変わるので、アドレスサーチ機能
を付けています。おまけモードを起動し、一歩も動かずに Ctrl+P を押して設定ダイ
アログを開き、searchボタンを押すとアドレスが取得されます(ごく稀に取得できな
いことがあるかも)。</p>

<p>ゲーム開始直後に必ずおまけモードを起動し、自機座標アドレスサーチをかけて
ください。これを行わないとステートロード時のdesync判定ができなくなります。</p>

<p>0.2.0 でdesync問題はかなり改善されましたが、まだごく稀にdesyncが発生しま
す。ムービー及びステートには最終フレームでの自機座標などが記録されているので、
desync発生時はその旨報告するダイアログが出ます。</p>

<p>乱数などのアドレスは環境によって変わるかもしれないので、その場合はソース
を修正するか、Ctrl+P で設定し直してください。</p>

<h3>スクリーンショット</h3>

<div><img src="tasryoko.png" alt="tasryoko screenshot"></div>

<h3>キーバインド</h3>

<table border="1">
  <tr><th>キー</th><th>機能</th></tr>
  <tr><td>A</td><td>左ボタントグル</td></tr>
  <tr><td>D</td><td>右ボタントグル</td></tr>
  <tr><td>W</td><td>上ボタントグル</td></tr>
  <tr><td>S</td><td>下ボタントグル</td></tr>
  <tr><td>Z</td><td>式神ボタントグル</td></tr>
  <tr><td>X</td><td>ジャンプボタントグル</td></tr>
  <tr><td>C</td><td>御札ボタントグル</td></tr>
  <tr><td>Shift+ADWSZXC</td><td>各ボタンを「離してから押す」。2Fダッシュに必要</td></tr>
  <tr><td>\</td><td>frame advance</td></tr>
  <tr><td>Pause</td><td>ポーズ</td></tr>
  <tr><td>Tab</td><td>ターボ(ムービー中は無効)</td></tr>
  <tr><td>Shift+Tab</td><td>ターボトグル(ムービー中は無効)</td></tr>
  <tr><td>Alt+P</td><td>ムービー再生</td></tr>
  <tr><td>Alt+R</td><td>ムービー記録/追記</td></tr>
  <tr><td>Alt+Q</td><td>ムービー停止</td></tr>
  <tr><td>F1-F10</td><td>ステートロード</td></tr>
  <tr><td>Shift+F1-F10</td><td>ステートセーブ</td></tr>
  <tr><td>Ctrl+P</td><td>各種設定(自機座標アドレスなど)</td></tr>
  <tr><td>Ctrl+H</td><td>キーボード/ウィンドウフックトグル</td></tr>
</table>

<h3>更新履歴</h3>

<dl>
  <dt>0.2.3</dt>
  <dd><p>式神に関するデータを表示するようにした(自機x座標アドレスを取得して
  おく必要がある)</p></dd>
  <dt>0.2.2</dt>
  <dd><p>*.rfr.st にフレーム別の追加ウェイトを記録できるようにした(UIにはま
  だ反映されていない)。BGMが途中で変化する面では、BGMの変わり目で追加ウェイ
  トを入れてやらないとdesyncする(面にもよるが、timeGetTime() が30回程度呼ば
  れるまで待てばいいようだ)。</p></dd>
  <dt>0.2.1</dt>
  <dd><p>Ctrl-H で一時的にキーボード/ウィンドウフックを無効化できるようにし
  た。*.rfr.sdt の内容が正しくないとゲーム側のリプレイ機能でムービー再生がう
  まくいかない現象への暫定的な対処。</p></dd>
  <dt>0.2.0</dt>
  <dd>
  <p>偽DLL方式からDLL injection+IATパッチ方式へ変更。これにより、所属DLLを気
  にせず任意のAPIをフックできるようになった(今のところ役に立っていないが)。
  また、DLLのサイズが変わっても乱数などのアドレスが変化しなくなった。</p>
  <p>timeGetTime() の呼び出し回数を基準としたウェイト処理を実装。これにより
  desyncが激減した。また、ステートロードが高速化した。</p>
  </dd>
  <dt>0.1</dt>
  <dd><p>作った(偽DLL方式)</p></dd>
</dl>


<h2>キーファイル</h2>

<p>キーファイルはrfrファイルフォーマットとなっています(TASツールを組み込んで
いない状態でもF8キーで再生可能)。また、*.rfr.st にdesync検出用データが格納さ
れています。</p>

<p>なお、F8キーで再生する際は *.rfr.sdt ファイルも必要になります。これは同ス
テージの他のムービーのものを流用できる場合もありますが、そうするとたまに再生
がうまくいかない(最終フレームで鳥居に入れない)ことがあるので、Ctrl-Hでウィン
ドウのアクティブ化を許可し、F7キーで *.rfr.sdt を書き出させるのが確実です。</p>

<table border="1">
  <tr><th>ステージ</th><th>キーファイル</th></tr>
  <tr><td>1-1</td><td><a href="movie/1_1-000864.zip">00:08.64</a></td></tr>
  <tr><td>1-3</td><td><a href="movie/1_3-000832.zip">00:08.32</a></td></tr>
  <tr><td>1-4</td><td><a href="movie/1_4-001352.zip">00:13.52</a></td></tr>
  <tr><td>2-1</td><td><a href="movie/2_1-001411.zip">00:14.11</a></td></tr>
  <tr><td>2-5</td><td><a href="movie/2_5-000648.zip">00:06.48</a></td></tr>
  <tr><td>2-7</td><td><a href="movie/2_7-000916.zip">00:09.16</a></td></tr>
  <tr><td>3-4</td><td><a href="movie/3_4-000841.zip">00:08.41</a></td></tr>
  <tr><td>3-5</td><td><a href="movie/3_5-000385.zip">00:03.85</a></td></tr>
  <tr><td>4-3</td><td><a href="movie/4_3-000872.zip">00:08.72</a></td></tr>
  <tr><td>4-5</td><td><a href="movie/4_5-000878.zip">00:08.78</a></td></tr>
  <tr><td>4-6</td><td><a href="movie/4_6-001348.zip">00:13.48</a></td></tr>
  <tr><td>6-3</td><td><a href="movie/6_3-001598.zip">00:15.98</a></td></tr>
  <tr><td>9-2</td><td><a href="movie/9_2-002230.zip">00:22.30</a></td></tr>
</table>


<h2>各種調査</h2>

<h3>x速度</h3>

<p>速度に比例する抵抗がかかっています。以下は測定値から類推した加速度です(逆
アセンブルなどは行っていません)。</p>

<h4>地上での自然減速(横方向入力なし)</h4>
<p>加速度 -0.3133*(速度)</p>

<h4>歩き移動</h4>
<p>加速度 0.94176 - 0.2152*(速度)</p>

<h4>ダッシュ移動</h4>
<p>加速度 1.42164 - 0.2152*(速度)</p>

<h4>しゃがみ移動</h4>
<p>加速度 0.70632 - 0.2152*(速度)</p>

<h4>空中移動</h4>
<ul>
  <li>(速度の絶対値) &gt; 4.0 の場合、加速度 -0.019*(速度)</li>
  <li>(速度の絶対値) &lt;= 4.0 の場合、0.3程度加速(詳細未調査)</li>
</ul>

<p>上下左右同時押しは特に意味がないようです(上下/左右同時押しは無入力状態と
同様に扱われる模様)。</p>

<h3>式神</h3>

<p>式神は4つのモードを持ちます:</p>
<dl>
  <dt>モード0</dt>
  <dd>物理法則に従い、攻撃判定を持つが、自機との当たり判定は持たない。式神を
  投げた直後はこのモードになっている。式神が自機から離れるとモード1へ移行す
  る。また、敵に当たるか、連打回収を行うとモード3へ移行する。</dd>
  <dt>モード1</dt>
  <dd>物理法則に従い、攻撃判定および自機との当たり判定を持つ。自機と接触する
  (式神ジャンプする)とモード2へ移行する(このときy速度が3程度増加する)。また、
  敵に当たるか、最初に地形に当たってから48F(1Fずれることがあるかも)経過する
  か、画面外に出た時間が累計30Fになるか、連打回収を行うとモード3へ移行する。</dd>
  <dt>モード2</dt>
  <dd>重力の影響は受けるが、地形を無視し、一切の当たり判定を持たない。式神ジャ
  ンプを行った時点から16F経過するとモード3へ移行する。連打回収を行ってもこの
  待ち時間を減らすことはできない。</dd>
  <dt>モード3</dt>
  <dd>高速で自機のところへ戻ってくる。重力、地形を無視し、一切の当たり判定を
  持たない。</dd>
</dl>


<h2>関連リンク</h2>

<ul>
  <li><a href="http://www.studio-ryokucha.com/ryouko.html">公式サイト</a> (体験版あり)</li>
  <li><a href="http://www.geocities.jp/mikoryoko/MikoRyoko/">『巫女さんファイター涼子ちゃん』を勝手に応援するページ</a> (以前作った攻略サイト)</li>
  <li><a href="http://www.dark.s-nick.net/">ダークパラダイス</a> (リプレイあり)</li>
  <li><a href="http://www.foolmaker.net/">愚者の館</a>
  (<a href="http://wcs.main.jp/index/software/spal/">SpoilerAL</a>用のssgファ
  イルあり(検証の際に有用)。攻略記事もあり)</li>
</ul>


<hr>

<p><a href="../../">Back</a></p>

</body>
</html>
