<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>カトちゃんケンちゃん(PCE) TAS</title>
</head>

<body>

<h1>カトちゃんケンちゃん(PCE) TAS</h1>

<p>とりあえず 07:44.10 のTASを作成
(<a href="http://tasvideos.org/1291M.html">TASVideos掲載ページ</a>)。現在の
知識の範囲内では一応ベストを尽くしたつもり。</p>

<p>07:44.10 (<a href="KatoKen-002-27765F.zip">mcmファイル</a>)</p>
<iframe width="312" height="176" src="http://ext.nicovideo.jp/thumb/sm7088500" scrolling="no" style="border:solid 1px #CCC;" frameborder="0"><a href="http://www.nicovideo.jp/watch/sm7088500">【ニコニコ動画】[TAS] PCE カトちゃんケンちゃん in 07:44.10</a></iframe>

<p>テストラン 07:49.19 (<a href="KatoKen-001-28070F.zip">mcmファイル</a>)</p>
<iframe width="312" height="176" src="http://ext.nicovideo.jp/thumb/sm6960058" scrolling="no" style="border:solid 1px #CCC;" frameborder="0"><a href="http://www.nicovideo.jp/watch/sm6960058">【ニコニコ動画】[TAS] PCE カトちゃんケンちゃん in 07:49.19</a></iframe>

<p>テストランからの更新点:</p>
<table border="1">
  <tr><th>区間</th><th>短縮量(F)</th><th>詳細</th></tr>
  <tr><th>1-1</th><td align="right">-17</td><td>ポテト取得、ノックバック*2、その他</td></tr>
  <tr><th>清算</th><td align="right">+56</td><td>体力調整</td></tr>
  <tr><th>1-2-A</th><td align="right">+1</td><td>着地硬直除去</td></tr>
  <tr><th>1-2-B</th><td align="right">-4</td><td>ノックバック*1, 着地硬直除去</td></tr>
  <tr><th>清算</th><td align="right">+28</td><td>体力調整</td></tr>
  <tr><th>1-3</th><td align="right">0</td><td></td></tr>
  <tr><th>1-4-A</th><td align="right">+48</td><td>ポテト回避、ハッシー処理最適化、その他</td></tr>
  <tr><th>1-4-B</th><td align="right">+19</td><td>ワープ処理最適化、その他</td></tr>
  <tr><th>WARP</th><td align="right">+1</td><td>xサブピクセル調整による着地硬直ロスの軽減</td></tr>
  <tr><th>3-1-A</th><td align="right">+7</td><td>着地硬直除去</td></tr>
  <tr><th>3-1-B</th><td align="right">-5</td><td>ノックバック*2, ハッシー処理最適化、その他</td></tr>
  <tr><th>清算</th><td align="right">+28</td><td>体力調整</td></tr>
  <tr><th>3-2-A</th><td align="right">+1</td><td>着地硬直除去</td></tr>
  <tr><th>3-2-B</th><td align="right">-4</td><td>ノックバック*1とそれに伴う減速、着地硬直除去</td></tr>
  <tr><th>清算</th><td align="right">+49</td><td>体力調整</td></tr>
  <tr><th>3-3-A</th><td align="right">+5</td><td>ハッシー処理最適化、着地硬直除去</td></tr>
  <tr><th>3-3-B</th><td align="right">+15</td><td>ワープ処理最適化、着地硬直除去</td></tr>
  <tr><th>6-4-A</th><td align="right">+3</td><td>着地硬直除去</td></tr>
  <tr><th>6-4-B</th><td align="right">+57</td><td>ハッシー処理最適化、鳥ジャンプ最適化、その他</td></tr>
  <tr><th>BOSS</th><td align="right">+17</td><td>ボスの後方に回らないようにしてボスのジャンプを遅らせた</td></tr>
  <tr><th>計</th><td align="right">+305</td><td></td></tr>
</table>

<p>3-1でカレーを取ると3-3のハッシーをゴリ押し突破できますが、それでも17Fほど
遅くなってしまうようです(一応
<a href="Curry-20315F.zip">3-3ハッシー直後まで進めたリプレイ</a>を置いておき
ます)。3-1のハッシーもゴリ押しできれば逆転しそうですが、こちらはどうしてもそ
の後の足場に着地できませんでした(ハッシーの出現をあと1F遅らせる方法があれば
いけそうなのですが…)。</p>

<p>3-1ラストは、落ちてくる缶を踏んで右の横移動足場に乗ることができれば5Fほど
速くなりそうなのですが、どうしても缶を踏んだ後の着地がうまくいかないようです
(3ピクセルほど足りない)。</p>

<p>3-2は体力調整が案外難しいです。鍾乳石*2の直後の落ちる足場からジャンプして
鳥→ヤクザで8ダメージ食らうこともできる(要yサブピクセル調整)のですが、これだ
とゴールする前に体力が尽きるようです。最新TASでは後半の鳥*2のところで少し減
速を交えて8ダメージ食らっていますが、ここではどのみち減速が必要になるので、
おそらくこれが最適と思います(ノックバック2回で4ダメージ*2を食らう方法も試し
ましたが、1F遅くなるようです)。</p>

<p>ボス戦についてはアルゴリズムをきちんと解析したわけではないのですが、どう
も一度もジャンプさせないということはできないようなので、ボスの無敵時間の間隔
からしてこれがほぼ限界なのではないかと思います。</p>

<p>1-2, 3-2はゴール判定後青画面が表示されるまで1F余計にかかるパターンになっ
てしまっており、色々試しましたが修正できませんでした。これについてはきちんと
原因を調べる必要がありそうです。</p>

<p>プログラム解析はほとんど手付かずに近いので、深く解析すれば新テクニックな
どが見つかるかも。ワープルートに関しては多分これ以外にはないと思いますが、
100%の確信はなし。</p>

<p>ワープなしverも見たいところですが、相当時間がかかると思われるので自分は作
れるかどうか微妙です^^;また、加藤verは志村に比べてサブピクセル調整や着地硬直
回避が難しいので、ワープありでもかなり苦労しそうです。</p>


<h2>各種調査</h2>

<p>加藤の方はあまりきちんと調べてないので不十分な点があるかも。</p>

<h3>キャラ特性</h3>

<table border="1">
  <tr>
    <th>キャラ</th>
    <th>x最高速度</th>
    <th>x加速</th>
    <th>x自然減速</th>
    <th>小ジャンプ初速</th>
    <th>中ジャンプ初速</th>
    <th>大ジャンプ初速</th>
    <th>重力</th>
  </tr>
  <tr><th>加藤</th><td>88</td><td>4</td><td>2</td><td>-49</td><td>-58</td><td>-65</td><td>3</td></tr>
  <tr><th>志村</th><td>96</td><td>3</td><td>1</td><td>-56</td><td>-65</td><td>-72</td><td>4</td></tr>
</table>

<p>志村は加速、自然減速が小さいのでブレーキ時に大きく滑ります。ジャンプ高度/
飛距離は加藤の方が上。</p>

<p>TAS的には志村の方が有利ですが、一部加藤でないと飛び越せないところがありま
す(1-2の隠し足場のある大穴や、6-4後半のファイアハッシーなど)。</p>

<h3>水平移動</h3>

<p>画面スクロールオフセット $2B3B と、画面内での自機x座標 $2B16 の和が自機の
マップ内x座標となります(2つの値はx座標が正しくなるように互いに整合性が保たれ
る)。画面内x座標は右キーを押しっぱなしにしていると 79 に固定されますが、右キー
を離すとそれより大きい値にすることもできます(厳密な法則は未調査)。</p>

<p>現フレームでのx移動距離は $2B22(ピクセル), $2B23(サブピクセル) で管理され
ており、$2B22 の値がマップ内自機x座標に加えられます。前フレームの $2B23 の値
と現フレームの自機の速度の和をとり、32で割った商が $2B22, 余りが $2B23 とな
ります。ただし、壁に当たる場合は $2B22 が壁にめり込まないように修正されます。</p>

<p>自機のx速度は $2B24 で管理されています。1Fごとに、左右キーを入力していれ
ばその方向にキャラ固有の加速値が、入力していなければ0に近づく方向にキャラ固
有の自然減速値が加えられます。ただし、絶対値はキャラ固有の最高速度を超えるこ
とはありません。なお、速度計算は移動距離計算より先に行われます。また、壁に当
たっても速度には影響しません(壁に当たったまま速度を増していくこともできる)。</p>

<p>少々わかりにくいので計算式をまとめてみます:</p>
<blockquote><pre>
  $2B24 += accel();     // 前述の通りに速度を変化させる。例えば志村で右を入力していたら3を加える
  $2B23 += $2B24;       // サブピクセルに速度を加える
  $2B22 = $2B23 / 32;   // それを32で割った商がピクセルとなる
  $2B23 %= 32;          // 余りがサブピクセルとなる
</pre></blockquote>

<p>志村の場合、最高速度が96なので、そこに達してしまえば移動距離ピクセルは常
に3で、サブピクセルは変化しません。加藤の場合、最高速度が88なので、最高速で
も4Fに1回移動距離ピクセルが2になります。</p>

<p>サブピクセル $2B23 は速度のみに依存し、面クリア以外ではリセットされません
(立ち止まったり、エレベーターに乗ったり、ジャンプ台でワープしたりしても値が
維持される)。このため、ピクセル $2B22 を変化させることなくサブピクセルを調整
しておくことで、後々の移動をわずかに調整できます。例えば、志村なら最高速の状
態から右キーを1F離してまた押せばサブピクセルを1減らせます。</p>

<p>サブピクセルに余裕があれば、一瞬振り返って物を蹴ったりしても移動距離が変
化せずに済みます。</p>

<p>横移動足場の上では毎フレーム自機が1ピクセル追加で動きます。</p>

<h3>垂直移動</h3>

<p>自機のy座標は $2B18 (16bit, リトルエンディアン)で管理されています。</p>

<p>現フレームでのy移動距離は $2B21(ピクセル), $2B20(サブピクセル)で管理され
ており、$2B21 の値がy座標に加えられます。前フレームの $2B20 の値と現フレーム
の自機の速度の和をとり、8で割った商が $2B21, 余りが $2B20 となります。</p>

<p>自機のy速度は $2B1F で管理されており、キャラ固有の重力加速度 $2B32 が毎フ
レーム加えられます。ただし着地した状態では0になります。なお、速度計算は移動
距離計算より先に行われます。</p>

<p>計算式まとめ:</p>
<blockquote><pre>
  $2B1F += $2B32;       // 速度にキャラ固有の重力加速度を加える
  $2B20 += $2B1F;       // サブピクセルに速度を加える
  $2B21 = $2B20 / 8;    // それを8で割った商がピクセルとなる
  $2B20 %= 8;           // 余りがサブピクセルとなる
</pre></blockquote>

<p>yサブピクセルはxサブピクセルに比べて調整が面倒(着地硬直が絡むため)ですが、
動く足場/落ちる足場を利用すると比較的容易に調整できます。なお、yサブピクセル
もxサブピクセル同様、面クリア以外ではリセットされません。</p>

<h3>ジャンプ</h3>

<p>ジャンプ高度は3種類あり、ジャンプボタンを押す瞬間の自機の水平方向の速度に
より以下のように変化します(志村、加藤共通):</p>
<ul>
  <li>(速度の絶対値) &lt; 48 ならば小ジャンプ</li>
  <li>48 &lt;= (速度の絶対値) &lt; 80 ならば中ジャンプ</li>
  <li>80 &lt;= (速度の絶対値) ならば大ジャンプ
</ul>
<p>ただし、上成分+ジャンプボタン、または蹴りボタン+ジャンプボタンを入力した
場合は無条件に大ジャンプとなります。</p>

<p>中ジャンプ、小ジャンプをうまく使うと短縮になるケースもあります。</p>

<h3>着地硬直</h3>

<p>着地時にy座標が地面のy座標を一時的に超える場合、1Fの硬直($2B22 が0になり、
水平移動が停止する)が発生します(1Fの間「地面に埋まった」と考えるとわかりやす
いかも)。ただし、足場の右端に乗り出すように着地した場合は発生しません。また、
敵/動く足場/落ちる足場に乗る際にも発生しません。</p>

<p>着地硬直が起こると1F分移動が遅れてしまうので、可能な限り回避したいところ
です。回避する方法は</p>
<ul>
  <li>足場の右端に着地する</li>
  <li>敵を踏んでから着地することでy座標を調整する</li>
  <li>事前にyサブピクセルを調整しておく</li>
</ul>
<p>といったところですが、どうしても避けられないケースもあります。</p>

<p>志村の場合、同じ高さに小/大ジャンプしたときは着地硬直が発生しません。加藤
の場合は同じ高さへの大ジャンプでも硬直が発生します。</p>

<h3>蹴り</h3>

<p>蹴りは一度当たるとそれ以降は判定が消えます。ただし、一度に複数の対象に当
てることはできます。</p>

<p>蹴りは自機の座標には影響しません。</p>

<h3>しゃがみ/屁</h3>

<p>しゃがむと当たり判定が若干低くなるので、ネズミや缶などをきわどいところで
避けられることもあります。</p>

<p>しゃがんだ時点から1Fごとにカウンタ $2B27 がインクリメントされ(「屁タイ
マー」と呼称する)、この値が20になると屁が発射されます。なお、しゃがむたびに
屁タイマーは0にリセットされるので、事前にタイマーを進めておくことはできない
ようです。</p>

<p>ポテトを取るたびに屁の射程($2B28)が1増えます。TAS的にはポテトは1つで事足
りると思います。</p>

<p>なお、屁の速度は2ピクセル/Fのようです。</p>

<h3>ノックバック</h3>

<p>ノックバックの向きは、ダメージを食らう瞬間の自機の向きに依存します。ノッ
クバック時はx速度の絶対値が40に, y速度が-24に修正されます(移動ピクセル/サブ
ピクセルはそのまま)。このゲームは滑りやすいので、素早く方向転換したい場合は
ノックバックを利用する方がよい場合があります(と書きましたが、1-4のワープは普
通に減速した方が速いです^^;)。</p>

<p>ノックバックが発生すると自機点滅タイマー $2B1D が60になり、以降1Fごとにデ
クリメントされます。$2B1D が15以上の間は無敵となるようです。また、食らい無敵
が解ける瞬間に再度ダメージを食らうとノックバックが発生しないようです。</p>

<p>志村の場合、着地状態でノックバックすれば着地硬直は発生しません。また、ノッ
クバック1回につき約5Fのロスとなります(xサブピクセルを31にしておき、ノックバッ
クの瞬間に左を向いた場合)。</p>

<h3>体力</h3>

<p>初期体力は10で、カレーを取ると最大値が2増えます。</p>

<p>2Fごとにカウンタ $2B25 がデクリメントされ(「体力減少タイマー」と呼称する)、
0になると体力が1減ります。体力減少タイマーは面クリアまたは体力の増減時(ポテ
ト以外の食べ物を取る、ダメージを食らう)に 0xFF にリセットされます。エレベー
ター、ワープではリセットされません。</p>

<p>なお、ボス戦では体力の自然減少は発生しません。</p>

<h3>オブジェクト生成(缶、アイテムなど)</h3>

<p>相方や敵が缶を投げたり、蹴りによってアイテムを出現させると、オブジェクト
生成カウンタ $2213 がインクリメントされます。このカウンタは次のオブジェクト
生成に影響を与えます。</p>

<p>相方の投げる缶の軌道は $2213 に依存しているようです。</p>

<p>アイテムの出る向きは、$2213 とフレーム数(偶数か奇数か)に依存しているよう
です。ただしウンコについては自機の位置に依存するようです。</p>

<p>このゲームは比較的 hex-editing に優しいですが、$2213 が変わったり、奇数フ
レームのずれが生じるような編集を行うとまず同じ挙動にはならないと考えるべきで
す。</p>

<h3>ゴール判定</h3>

<p>画面を最後までスクロールさせた状態で画面内x座標が 144 以上になるとゴール
とみなされるようです。</p>

<p>ゴール判定が行われてから青画面が表示されるまでのフレーム数は1Fのブレがあ
るようです。これについては今のところ原因も対処法も不明。ゴール手前で少し減速
したりすると1F短くなるケースもあるようですが…。</p>

<h3>面クリア時の清算処理</h3>

<p>体力が多いとその分清算処理に時間がかかります(体力1につき7Fのロス)。よって、
可能ならば瀕死で面クリアした方が速いです。</p>

<h3>エレベーター</h3>

<p>エレベーターは、自機が速度0の状態で上に乗っていると動き出します。</p>

<h3>ボスの挙動</h3>

<p>あまり詳しいことはわかっていませんが、基本的に、後ろに回ろうとするとすぐ
にジャンプしてしまうようです(半分くらいまでめり込んだ時点で確定?)</p>

<h3>OP処理</h3>

<p>志村を使う場合、155FにRUN, 156FにSELECT, 157FにRUN, 164FにRUN, として、
294Fから入力受付開始となります。</p>

<h3>雑多なこと</h3>

<p>メーカーロゴは多分飛ばせないと思います。</p>

<p>ラグカウンタを見る限り、基本的にラグは発生しないようです。</p>

<p>frame ruleの類は多分存在しないと思います(1F短縮すればその後もずっと1F速い
ままということ)。ただ、鳥が画面外に出てから再出現するタイミングに関しては
frame rule のようなものが存在するかも。</p>

<p>左右同時押しは左が、上下同時押しは上が優先されます。また、下+ジャンプは単
にしゃがむだけです。</p>

<p>敵を蹴ると1Fだけ魚のグラフィックが表示されます。</p>

<p>各ワールドの4面でゴールラインを通過し、ボス戦の音楽が流れ始めた後に死ぬと、
そのまま画面停止してハマります(音楽は鳴りっぱなし)。</p>


<h2>テクニック</h2>

<p>文章だけ読んでもわかりにくいと思うので、メモリを見つつ読んでもらえれば。</p>

<h3>着地硬直を利用したxサブピクセル調整</h3>

<p>着地硬直が避けられない場合、硬直フレームではxピクセルが0になるので、この
フレームを利用してxサブピクセルを調整することができます。例えば、志村でxサブ
ピクセル0, x速度96の状態で着地硬直する場合、硬直フレームで右キーを離せばxサ
ブピクセルを31まで回復できます。</p>

<h3>着地硬直によるロスの軽減</h3>

<p>ワープ直後など、着地硬直フレームで自機が最高速度に到達していない場合は、
事前にxサブピクセルを調整しておくことで着地硬直によるロスを1ピクセル減らせる
ことがあります。最新のTASでは、1-4からワープゾーンに移動する際にこのテクニッ
クを使用し、ワープゾーンを1F短縮しています。</p>

<h3>開幕空中ジャンプ</h3>

<p>面開始1Fのみ空中ジャンプが可能です(ワープ直後は不可)。志村の場合、面開始
直後は必ず着地硬直が発生し、右押しっぱなしで普通に着地すると1ピクセル、開幕
空中大ジャンプだと3ピクセルのロスとなります。これだけ見ると空中ジャンプは損
なのですが、開幕空中大ジャンプを行うとyサブピクセルが4になるため、これによっ
てその後の着地硬直を回避できるならば、差し引き1ピクセル得になります。ワープ
ありだとこの技は出番がない(最新TASでは1-1で行っているが、ポテトを取っている
関係で結果的に損得なし)ですが、ワープなしならば使える面があるかも。</p>

<h3>スクロール調整</h3>

<p>画面内x座標を増加させてスクロールを一時的に抑制すると、敵の出現タイミング
を微妙に変化させることができるようです。テストランの時点から6-4-Aのハエジャ
ンプ地帯ではこれを利用しています。</p>

<p>まだ画面内x座標とスクロールオフセットの関係について厳密に調べてはいないの
で、もしかするとこの技で短縮可能なところがまだあるかもしれません。</p>

<h3>エレベーターの乗り降り</h3>

<p>乗り方は、ギリギリで大ジャンプして限界まで右押しっぱなし→全力で減速、と
するのが最速だと思います(事前にサブピクセルを調整したり、減速し始めは自然減
速にするなど微調整の余地はありますが)。中ジャンプを使う方法も試しましたが、
中ジャンプのための減速によるロスの方が大きいようです(小ジャンプは言わずもが
な)。当然ながら、可能ならばxサブピクセル調整を行うべきです。</p>

<p>降りる際は、志村ならばyサブピクセルを4未満にしておいて中ジャンプすれば硬
直なしで降りられます。というわけで、エレベーターに乗る前はyサブピクセルも調
整しておく必要があります。</p>

<h3>壁めり込み</h3>

<p>このゲームは「天井にぶつかる」という概念がないようで、ブロックの下からジャ
ンプすると普通にすり抜けます。たとえば、6-4ラストの落ちる足場3連続のところは、
最後の落ちる足場に乗ったまま隣の床下に潜り込んでジャンプすることで下から地面
にめり込むことができます:</p>
<div><img src="glitch-01-6_4.png" alt="床下から地面にめり込む図" border="0"></div>
<p>この状態からジャンプすればブロックの上に抜けられます。</p>

<p>ワープありの場合、6-4ではどのみち鳥を待たなければならないので、これを行っ
ても短縮にはならないと思いますが、ワープなしならば使えるかも。</p>


<h2>資料</h2>

<ul>
  <li><a href="memory.txt">メモリマップ</a></li>
  <li><a href="KatoKen.lssave">MHS用アドレスリスト</a>(mednafen-rr-137 用)</li>
</ul>

<p><a href="../../doc/mednafen.html">mednafen-rr メモ</a>も参照。</p>


<h2>関連リンク</h2>

<ul>
  <li><a href="http://www7.ocn.ne.jp/~bacube/oldgame29/kato_ken_01.html">バキューブJr.の5thブロック - カトちゃんケンちゃん</a></li>
  <li><a href="http://web.archive.org/web/*/http://www2.netwave.or.jp/~seva/katoken.htm">もみじ荘 - カトケン。</a> (WebArchive)</li>
  <li><a href="http://www.geocities.jp/kojimaosi/gamekatoken.htm">乱具 - カトケン</a></li>
</ul>


<hr>

<p><a href="../../">Back</a></p>

</body>
</html>
