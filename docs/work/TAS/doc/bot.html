<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>TAS 関連 - Bot による最適化</title>
</head>

<body>

<h1>Bot による最適化</h1>

<p>入力の選択肢が多すぎて手動では網羅しきれない場合、Bot を使うと大幅な省力
化/最適化が期待できます。</p>

<p>Bot による最適化の簡単な流れ:</p>
<ul>
  <li>ステートセーブ</li>
  <li>決められた時間、ランダムor総当たり入力を行う</li>
  <li>入力を終えたらメモリを見るなどして解(望む結果)が得られたか調べる(終了判定)</li>
  <li>解が得られたらステートセーブor入力を記録。得られなかったらステートロードして最初に戻る</li>
</ul>

<p>本来はきちんと逆アセンブル解析を行った方が効率的なんだろうと思いますが、
ゲームによってはそこまで詳しく解析しなくても何とかなります。ただし、終了判定
だけは最低限必要なので、そのためのメモリアドレスくらいは調べておく必要があり
ます。</p>

<p>どうしても終了判定ができない場合は、最後の手段としてランダム入力のみを行
う似非 Bot を作成し、判定は目視で行うという手があります。これでも全て手動で
やるよりはマシです。</p>

<h2>各種 Bot 実装</h2>

<h3>FCEU BasicBot</h3>

<p>BasicBot は低機能ですが手軽に使えます。ただし多少複雑な入力が必要な場合に
は力不足。FCEU 0.98.26 で動作確認(FCEU 0.98.28 ではなぜか External Input が
グレーアウトしているため動作しない。FCEU 0.98.27 は未確認)。</p>

<p>FCEU バイナリにドキュメント(bot.html)が同梱されていますが、わかりにくいの
で補足しておきます。</p>

<p>まず、左上のボックスで各ボタンの入力確率を設定。値は 0～1000 で、大きいほ
ど入力確率が上がります(0 なら入力なし、1000 なら押しっぱなし)。</p>

<p>次に終了条件(End when)の設定。ここは frame 変数や mem() 関数を使うことが
多いと思います。たとえば、50 フレーム後に終了するなら <code>frame=50</code>,
メモリアドレス $025B の値が 0 以外になったときに終了するなら <code>mem(x25B)
!= 0</code> のようにします。</p>

<p>最後に最大化したい値(Maximize)の設定。たとえば、メモリアドレス $025B の値
を最大にしたいなら <code>mem(x25B)</code> とします。なお、値を最小化したい場
合は負符号を付ければOK。Tie break 項目で Maximize 値が同点だった場合の判定基
準を追加できるので、たとえば <code>-frames</code> を設定しておけば同じ
Maximize 値で最短の入力が得られることになります(frames 変数は経過フレーム数
を表す)。</p>

<p>望ましい解が得られたら、&quot;Play Best&quot; でその入力を再生し、手動で
ステートセーブすればOK。</p>

<p>ただし、BasicBot は論理演算子がない?(代替手段はあるが面倒)のと、演算子の
優先順位が怪しい(加算が乗算より先に処理されたりする)など、あまり完成度が高く
ないので、これ一本だとちょっと苦しいと思います。</p>

<h3>FCEU Lua スクリプトによる Bot</h3>

<p>Lua スクリプトを使うとかなり柔軟な処理が可能になります。Lua 言語自体もそ
れなりに完成されているので、BasicBot などに比べると記述性ははるかに高いです。
Lua スクリプト機能は FCEU 0.98.27 以降で使えます。</p>

<p>簡単な例を示しておきます:</p>
<blockquote><pre>
-- 現在時刻で乱数を初期化
math.randomseed(os.time())

-- 描画は必要ないので最高速モードにする
FCEU.speedmode("maximum")

-- やり直し用ステートの作成
local state = savestate.create()
savestate.save(state)

-- 1000 回試行
for i = 1, 1000 do
    attempt()

    -- 解が求まったら 1 番にステートセーブ
    if success() then
        local state_good = savestate.create(1)
        savestate.save(state_good)
        break
    end

    -- 解が見つからなかったのでステートロードして再試行
    savestate.load(state)
end
</pre></blockquote>
<p><code>attempt()</code> 内では <code>joypad.set()</code>,
<code>FCEU.frameadvance()</code> などを使って入力を生成しつつフレームを進め
ます。<code>success()</code> は終了判定で、<code>memory.readbyte()</code> な
どを使って判定を行います。あまり複雑なことをしない Bot ならこの例の変形で作
成できると思います。</p>

<p>ただし、逆アセンブル解析を行わない場合、入力生成部
(<code>attempt()</code>)をコーディングする前に手動での事前調査(コマ送りして
フレーム数を計算)が必要になるので、Bot を使う場面が多い場合は少々しんどいと
思います。逆アセンブルするまでもなく毎回同じ入力ルーチンが使い回せるとわかっ
ている場合は別ですが…。</p>

<h2>その他</h2>

<p>FCEU は、特定フレームを終端として Bot を回すといきなりエミュレータの動作
が停止(画面が崩れ、<code>memory.readbyte()</code> が必ず 0 を返すようになる)
したり、原因不明のリセットがかかったりするようです(FCEU 0.98.28, 0.98.26 で、
BasicBot/LuaBot 双方で確認。サウンドが鳴っている場面の特定フレームで繰り返し
ステートロードすると発生しやすい?)。この現象が起こった場合は、
<code>savestate.load()</code> の前に数回 <code>FCEU.frameadvance()</code> し
てやると改善されると思います。</p>


<hr>

<p><a href="../">Back</a></p>

</body>
</html>
