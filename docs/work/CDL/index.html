<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>CDL計画</title>
</head>

<body>

<h1>CDL計画</h1>

<h2>CDL計画とは</h2>

<p>ビデオゲームの解析のために、
<a href="http://fceux.com/web/htdocs/">FCEUX</a>で実装されているような
Code/Data Logger(以下CDL)を活用してみようという試みです。今のところNES限定に
なると思います(私はNES以外はほとんどわからないので^^;)</p>

<p>CDLとは、「プログラム内でどの部分がコードとして使われ、どの部分がデータと
して使われたか」のログをとるツールです。当然、ログに記録されるのはプログラム
動作中にアクセスされた領域のみなので、プログラム全体のログをとるためには色々
な方法でプログラムを動作させ、なるべく多くのコード/データへのアクセスを発生
させる必要があります。</p>

<p>大まかな雰囲気を示すために、FCの「F1レース」のCDLログを後述の cdl2txt で
<a href="F1Race.cdl.html">HTML化したもの</a>を置いておきます。</p>


<h2>CDLの利点</h2>

<p>CDLのわかりやすい利点として、逆アセンブルが楽になることが挙げられます。一
般に、逆アセンブラはコード領域とデータ領域を完全には判別できないため、しばし
ば以下のようなアセンブルリストが出力されます
(<a href="http://www.geocities.co.jp/SiliconValley/5457/">md6502</a> を使っ
た例):</p>
<blockquote><pre>
  C541 : 02             db      #$02            ;
  C542 : 05 20          ora     $20             ;
  C544 : 1B             db      #$1B            ;
  C545 : C9 A2          cmp     #$A2            ;
  C547 : 00             brk                     ;
</pre></blockquote>
<p>上の例では、実際には $C542 までがデータ領域であり、コード領域は $C543 か
ら始まるのですが、逆アセンブラがコード/データ境界を検出できずに誤ったコード
を出力しています。これを手直ししてやると:</p>
<blockquote><pre>
  C541 : 02             db      #$02            ;
  C542 : 05             db      #$05            ;

  C543 : 20 1B C9       jsr     $C91B           ;
  C546 : A2 00          ldx     #$00            ;
</pre></blockquote>
<p>のようになります。しかし、こうした修正作業は面倒(私の場合、命令表を参照し
ないと機械語が読めない^^;)なので、事前にできるだけコード/データ領域を特定し
ておき、逆アセンブラにデータ領域を教えてあげるようにすれば、修正の手間がかな
り軽減されるというわけです。</p>

<p>CDLには他にも以下のような利点があります:</p>
<ul>
  <li>長時間プログラムを動作させてもログに残らない領域は、通常のプレイでは滅多
  にアクセスされないと考えられるので、そこに注目することで新テクニックや裏技
  などのヒントが得られる可能性がある。特に、コード領域内にポツンと不明領域が
  ある場合、滅多に発生しない分岐の可能性がある</li>
  <li>コード/データ兼用になっている領域を検出できる</li>
  <li>既存のログに追加する形でログをとれるので、多人数で分担することもできる。
  しかも、ログ採取はCDLを動作させた状態で普通にゲームをプレイするだけの簡単
  な作業なので誰でもできる。</li>
  <li>FCEUXの場合、indirect accessの検出もできるので、ポインタを介してアクセ
  スされるコード/データの特定に役立つ。また、DPCMデータの検出も可能</li>
  <li>FCEUXの場合、Trace Loggerとの連携も可能(CDLログに記録されていないコー
  ド/データアクセスのみをトレースできる)</li>
</ul>


<h2>CDLの使い方</h2>

<p>とりあえずFCEUXでの例:</p>
<div><img src="cdl-fceux.png" alt="FCEUX CDL screenshot"></div>
<p>ゲーム起動後、メニューからCDLを起動すると上のようなウィンドウが現れるので、
&quot;Start&quot; を押してやるとロギングが開始されます。後は適当にプレイする
だけ。ログの読み込み/保存はLoad/Saveボタンから。</p>

<p>ゲームにもよると思いますが、なるべく隅々まで網羅するような感じでプレイす
れば網羅率(100 から &quot;Bytes Not Logged&quot; の数値を引いたもの)は8～9割
程度にはなると思います。なお、コード/データ兼用領域が存在する場合もあるため、
必ずしも (コード率) + (データ率) = (網羅率) とはならないことに注意。</p>

<p>出力されるCDLファイルはiNESヘッダを取り除いたROM本体と同じサイズで、各
Byteにコード/データ区分を示すビットフラグが書き込まれています。詳しいフォー
マットについてはFCEUXのヘルプファイルを参照。</p>

<p>なお、&quot;Save Stripped iNes Rom...&quot; を押すと、CDLログに記録されな
かった領域を0で埋めた .nes ファイルが出力されます。</p>


<h2>ツール</h2>

<p>今のところCDLファイルに対応したツール類は見当たらないので、やっつけで自作
してみました(万人向けとは言いがたいものですが…)。</p>

<dl>
  <dt><a href="/appsouko/souko/pkg/cdl2txt-0.1.1.tar.bz2">cdl2txt</a></dt>
  <dd>16K単位に分割されたCDLファイルを読み取り、同じ値の領域をまとめた上でタ
  ブ区切りのテキストファイルに変換します。変換結果をHTMLや md6502 のオプショ
  ンファイルに変換するスクリプト(要Python)も同梱しています。なお、md6502.py
  を使用する場合は、オリジナルの md6502 を使用するとバッファ溢れで落ちる場合
  があるので、拙作の<a href="../md6502-mod/">md6502-mod</a>の使用を推奨しま
  す。</dd>
</dl>

<p>CDLファイルを直接読み込める逆アセンブラの制作を検討中です。</p>

<p>追記:
<a href="http://nesdev.parodius.com/bbs/viewtopic.php?t=4905">NesDevフォーラム</a>
のCelius氏がCDLに対応した逆アセンブラ(GUI)を開発しているようです。</p>


<h2>CDLログの公開</h2>

<p>私が採取したいくつかのCDLログを<a href="pub/">公開しておきます</a>。利用
はご自由に。</p>


<p>CDLログ採取/公開の際の指針などを適当に考えてみました:</p>
<ul>
  <li>網羅率を高めるため、なるべく多種多様なプレイを試みる</li>
  <li>チートは原則として使用しない(チート以外で実現できないアクセスがログに
  記録されるのは好ましくないので)</li>
  <li>CDLログを公開する際は、以下のような情報を付記する:
    <ul>
      <li>不明領域率(FCEUXのCDLダイアログに表示されるもの)</li>
      <li>どのような操作を行ったのか大まかに記しておく(他の人が同じような操
      作をせずに済むように)</li>
    </ul>
  </li>
</ul>


<hr>

<p><a href="../../">Back</a></p>

</body>
</html>
